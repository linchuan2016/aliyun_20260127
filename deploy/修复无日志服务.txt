==========================================
修复服务无日志问题（-- No entries --）
==========================================

【问题说明】
journalctl 显示 "-- No entries --" 表示：
1. 服务从未启动过
2. systemd 服务文件不存在
3. 服务未正确注册到 systemd


【完整诊断流程】

# 1. 检查服务文件是否存在
ls -la /etc/systemd/system/my-fullstack-app.service

# 2. 检查服务是否已注册
systemctl list-unit-files | grep my-fullstack-app

# 3. 检查服务状态
systemctl status my-fullstack-app --no-pager -l

# 4. 检查部署目录中的服务文件
ls -la /var/www/my-fullstack-app/deploy/my-fullstack-app.service


【如果服务文件不存在，创建服务文件】

# 方法一：从部署目录复制（如果存在）
cp /var/www/my-fullstack-app/deploy/my-fullstack-app.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable my-fullstack-app
systemctl start my-fullstack-app

# 方法二：手动创建服务文件
cat > /etc/systemd/system/my-fullstack-app.service << 'EOF'
[Unit]
Description=My Fullstack App Backend Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/my-fullstack-app/backend
Environment="PATH=/var/www/my-fullstack-app/venv/bin"
Environment="HOST=0.0.0.0"
Environment="PORT=8000"
Environment="ALLOWED_ORIGINS=http://47.112.29.212,https://linchuan.tech,http://linchuan.tech"
ExecStart=/var/www/my-fullstack-app/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable my-fullstack-app
systemctl start my-fullstack-app


【验证服务文件内容】

cat /etc/systemd/system/my-fullstack-app.service


【启动服务并检查】

systemctl daemon-reload && \
systemctl start my-fullstack-app && \
sleep 5 && \
systemctl status my-fullstack-app --no-pager -l && \
echo "" && \
echo "=== 检查日志 ===" && \
journalctl -u my-fullstack-app -n 20 --no-pager && \
echo "" && \
echo "=== 测试连接 ===" && \
curl -s http://127.0.0.1:8000/api/health || echo "连接失败"


【如果服务启动失败，手动测试】

# 1. 检查 Python 环境
cd /var/www/my-fullstack-app/backend
source ../venv/bin/activate
python -c "from main import app; print('Import OK')"

# 2. 手动启动测试（前台运行，查看错误）
cd /var/www/my-fullstack-app/backend
source ../venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000

# 如果手动启动成功，说明代码没问题，是服务配置问题
# 按 Ctrl+C 停止手动启动，然后检查服务配置


【检查服务配置的关键点】

# 1. 检查工作目录
grep WorkingDirectory /etc/systemd/system/my-fullstack-app.service

# 2. 检查执行命令
grep ExecStart /etc/systemd/system/my-fullstack-app.service

# 3. 检查环境变量
grep Environment /etc/systemd/system/my-fullstack-app.service

# 4. 检查虚拟环境路径
ls -la /var/www/my-fullstack-app/venv/bin/uvicorn


【完整修复流程（一键执行）】

# 检查并创建服务文件
if [ ! -f /etc/systemd/system/my-fullstack-app.service ]; then
    echo "服务文件不存在，正在创建..."
    if [ -f /var/www/my-fullstack-app/deploy/my-fullstack-app.service ]; then
        cp /var/www/my-fullstack-app/deploy/my-fullstack-app.service /etc/systemd/system/
    else
        echo "部署目录中也没有服务文件，需要手动创建"
        exit 1
    fi
fi

# 更新服务配置（确保 ALLOWED_ORIGINS 正确）
sed -i 's|ALLOWED_ORIGINS=.*|ALLOWED_ORIGINS=http://47.112.29.212,https://linchuan.tech,http://linchuan.tech|g' /etc/systemd/system/my-fullstack-app.service

# 重新加载并启动
systemctl daemon-reload
systemctl enable my-fullstack-app
systemctl start my-fullstack-app
sleep 5

# 检查状态
systemctl status my-fullstack-app --no-pager -l | head -20
journalctl -u my-fullstack-app -n 20 --no-pager
curl -s http://127.0.0.1:8000/api/health || echo "连接失败"


【实时查看日志（启动后）】

journalctl -u my-fullstack-app -f

