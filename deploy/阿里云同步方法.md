# 阿里云服务器代码同步方法

## 方法一：在服务器上直接执行脚本（推荐，最快）

### 步骤 1: 上传脚本到服务器（只需第一次）

```powershell
# 在 Windows PowerShell 中执行
scp deploy/sync-on-server-complete.sh root@47.112.29.212:/var/www/my-fullstack-app/deploy/
```

### 步骤 2: 在服务器上执行脚本

```powershell
# 通过 SSH 连接到服务器
ssh root@47.112.29.212

# 在服务器上执行
cd /var/www/my-fullstack-app
bash deploy/sync-on-server-complete.sh
```

或者一条命令执行：

```powershell
ssh root@47.112.29.212 "cd /var/www/my-fullstack-app && bash deploy/sync-on-server-complete.sh"
```

---

## 方法二：使用 Git 直接拉取（最简单）

### 在服务器上执行：

```bash
ssh root@47.112.29.212
cd /var/www/my-fullstack-app

# 保存本地修改（如果有）
git stash push -m "backup-$(date +%Y%m%d_%H%M%S)" 2>/dev/null || true

# 拉取最新代码
git fetch gitee main
git reset --hard gitee/main

# 更新后端依赖
cd backend
source ../venv/bin/activate
pip install --upgrade pip --quiet
pip install -r requirements.txt --quiet

# 初始化数据库
python init_db.py

# 构建前端
cd ../frontend
export NODE_OPTIONS="--max-old-space-size=2048"
npm install --silent
npm run build

# 重启服务
systemctl daemon-reload
systemctl restart my-fullstack-app
sleep 3
systemctl restart nginx

# 检查状态
systemctl status my-fullstack-app --no-pager -l | head -15
```

---

## 方法三：一键执行命令（Windows PowerShell）

创建一个简单的 PowerShell 脚本，只执行一次 SSH 连接：

```powershell
# sync-quick.ps1
$SERVER_IP = "47.112.29.212"
$SERVER_USER = "root"

Write-Host "正在同步代码到阿里云服务器..." -ForegroundColor Cyan

# 一次性执行所有命令（在服务器上）
ssh "${SERVER_USER}@${SERVER_IP}" @"
cd /var/www/my-fullstack-app
git stash push -m backup 2>/dev/null || true
git fetch gitee main
git reset --hard gitee/main
cd backend
source ../venv/bin/activate
pip install --upgrade pip --quiet
pip install -r requirements.txt --quiet
python init_db.py
cd ../frontend
export NODE_OPTIONS='--max-old-space-size=2048'
npm install --silent
npm run build
systemctl daemon-reload
systemctl restart my-fullstack-app
sleep 3
systemctl restart nginx
systemctl status my-fullstack-app --no-pager -l | head -15
"@

Write-Host "同步完成！" -ForegroundColor Green
```

---

## 方法四：使用 rsync 同步文件（适合大文件）

如果需要同步非 Git 文件，可以使用 rsync：

```powershell
# 同步整个项目（排除 node_modules, venv 等）
rsync -avz --exclude 'node_modules' --exclude 'venv' --exclude '.git' \
  ./ root@47.112.29.212:/var/www/my-fullstack-app/
```

---

## 推荐工作流程

1. **首次部署**：使用方法一，上传脚本到服务器
2. **日常更新**：使用方法二，直接在服务器上执行 Git 命令
3. **自动化**：在服务器上设置 cron 定时任务（可选）

### 设置定时同步（可选）

```bash
# 在服务器上编辑 crontab
crontab -e

# 添加每天凌晨 3 点自动同步（示例）
0 3 * * * cd /var/www/my-fullstack-app && bash deploy/sync-on-server-complete.sh >> /var/log/sync.log 2>&1
```

---

## 故障排查

如果同步后服务有问题：

```bash
# 查看后端日志
journalctl -u my-fullstack-app -n 100 --no-pager

# 查看 Nginx 错误日志
tail -n 50 /var/log/nginx/my-fullstack-app-error.log

# 测试 API
curl http://127.0.0.1:8000/api/health

# 执行修复脚本
cd /var/www/my-fullstack-app
bash deploy/fix-backend-complete.sh
```

---

## 性能优化建议

1. **使用服务器端脚本**：避免多次 SSH 连接，所有操作在服务器上一次性完成
2. **使用 Git 而不是文件同步**：Git 只传输变更，比 rsync 更快
3. **缓存 npm 依赖**：服务器上保留 node_modules，只更新变更的包
4. **使用 CDN**：静态资源使用 CDN 加速

