# 故障报告 - 2026年2月1日

## 故障时间线

- **开始时间**: 2026年2月1日 凌晨
- **结束时间**: 2026年2月1日 上午
- **持续时间**: 约 8-10 小时
- **影响范围**: 整个网站完全无法访问 (ERR_CONNECTION_RESET)

## 故障原因分析

### 根本原因

1. **Nginx 配置错误导致服务崩溃**
   - `/data/` location 配置位置错误（在 `/` location 之后）
   - 导致图片请求被前端路由捕获，在前端 `dist` 目录查找文件
   - 出现 `404 Not Found` 错误

2. **配置冲突和重复定义**
   - 存在重复的 `upstream attu` 定义
   - 导致 Nginx 配置测试失败：`duplicate upstream "attu"`
   - Nginx 无法启动或配置无法加载

3. **配置过于复杂**
   - 包含了大量不必要的 attu/milvus 相关配置
   - 配置文件中存在多个冲突的 server 块
   - 增加了排查和修复的难度

4. **权限问题**
   - Git 操作时图片文件权限不足
   - 导致 `git reset --hard` 失败
   - 无法正常同步代码

5. **配置应用流程不当**
   - 没有先测试配置就直接应用
   - 没有备份当前配置
   - 配置错误后没有快速回滚机制

## 故障影响

- **服务状态**: 完全宕机
- **错误信息**: `ERR_CONNECTION_RESET`
- **用户影响**: 所有用户无法访问网站
- **业务影响**: 服务中断约 8-10 小时

## 修复过程

### 阶段一：尝试修复图片问题
- 添加 `/data/` location 配置
- 但位置错误，导致问题恶化

### 阶段二：服务完全宕机
- Nginx 配置错误导致服务无法启动
- 尝试多次修复但引入新问题

### 阶段三：彻底重建
- 删除所有复杂配置
- 创建最简单的可用配置
- 只保留核心功能（前端、API、静态文件）
- 移除所有 attu/milvus 相关配置

### 最终修复方案
```nginx
# 最简单的可用配置
upstream backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name linchuan.tech www.linchuan.tech 47.112.29.212;
    
    root /var/www/my-fullstack-app/frontend/dist;
    index index.html;
    
    location /data/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
    
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 经验教训

### 1. 配置管理
- ❌ **错误做法**: 在配置文件中添加大量不必要的功能
- ✅ **正确做法**: 保持配置简洁，只包含必要的功能
- ✅ **正确做法**: 使用版本控制管理配置，每次修改前备份

### 2. Location 优先级
- ❌ **错误做法**: `/data/` location 放在 `/` location 之后
- ✅ **正确做法**: 更具体的 location（如 `/data/`）必须在通用 location（如 `/`）之前

### 3. 配置测试
- ❌ **错误做法**: 直接应用配置，不测试
- ✅ **正确做法**: 始终先执行 `sudo nginx -t` 测试配置
- ✅ **正确做法**: 测试通过后再应用配置

### 4. 权限管理
- ❌ **错误做法**: 使用不同用户创建文件，导致权限混乱
- ✅ **正确做法**: 统一使用服务用户管理文件权限
- ✅ **正确做法**: Git 操作前先修复权限

### 5. 故障恢复
- ❌ **错误做法**: 在故障时继续添加复杂功能
- ✅ **正确做法**: 故障时先恢复基本功能，再逐步添加功能
- ✅ **正确做法**: 保留最简单的可用配置作为备份

## 预防措施

### 1. 配置管理规范

#### 配置修改流程
```
1. 备份当前配置
   sudo cp /etc/nginx/conf.d/my-fullstack-app.conf /etc/nginx/conf.d/my-fullstack-app.conf.backup.$(date +%Y%m%d_%H%M%S)

2. 修改配置

3. 测试配置
   sudo nginx -t

4. 如果测试通过，应用配置
   sudo systemctl reload nginx

5. 如果测试失败，恢复备份
   sudo cp /etc/nginx/conf.d/my-fullstack-app.conf.backup.* /etc/nginx/conf.d/my-fullstack-app.conf
```

#### 配置原则
- ✅ 保持配置简洁，只包含必要的功能
- ✅ Location 顺序：具体路径在前，通用路径在后
- ✅ 避免重复定义（upstream、server_name 等）
- ✅ 每个配置修改都要有明确的理由和测试

### 2. 权限管理规范

#### 文件权限
```bash
# 项目目录
sudo chown -R www-data:www-data /var/www/my-fullstack-app
sudo chmod -R 755 /var/www/my-fullstack-app

# 数据目录（需要写权限）
sudo chown -R www-data:www-data /var/www/my-fullstack-app/data
sudo chmod -R 775 /var/www/my-fullstack-app/data

# Git 操作前
sudo chown -R $(whoami):$(whoami) /var/www/my-fullstack-app
```

### 3. 部署流程规范

#### 标准部署流程
```bash
# 1. 修复权限
sudo chown -R $(whoami):$(whoami) /var/www/my-fullstack-app
sudo chmod -R 755 /var/www/my-fullstack-app

# 2. 同步代码
cd /var/www/my-fullstack-app
git fetch gitee main
git reset --hard gitee/main

# 3. 修复数据目录权限
SERVICE_USER=$(systemctl show -p User my-fullstack-app | cut -d= -f2)
sudo chown -R "$SERVICE_USER:$SERVICE_USER" data/
sudo chmod -R 775 data/

# 4. 更新依赖（如需要）
cd backend && source ../venv/bin/activate && pip install -r requirements.txt --quiet

# 5. 构建前端（如需要）
cd ../frontend && npm install --silent && npm run build

# 6. 重启服务
sudo systemctl restart my-fullstack-app
sudo systemctl restart nginx

# 7. 验证
curl http://127.0.0.1:8000/api/health
curl http://127.0.0.1/api/health
```

### 4. 监控和告警

#### 建议添加的监控
- 服务状态监控（systemctl status）
- 端口监听监控（netstat/ss）
- API 健康检查（定期 curl /api/health）
- Nginx 错误日志监控
- 磁盘空间监控

### 5. 应急响应

#### 故障处理流程
1. **立即评估影响范围**
   - 检查服务状态
   - 检查错误日志
   - 确定影响范围

2. **快速恢复基本服务**
   - 使用最简单的可用配置
   - 先恢复 HTTP，再考虑 HTTPS
   - 先恢复核心功能，再恢复附加功能

3. **详细诊断**
   - 查看日志文件
   - 检查配置文件
   - 检查权限和防火墙

4. **逐步修复**
   - 一次只修复一个问题
   - 每次修复后验证
   - 不要同时修改多个配置

## 配置最佳实践

### Nginx Location 顺序（重要！）

```nginx
server {
    # 1. 最具体的路径在前
    location /data/ {
        # 静态文件代理
    }
    
    location /api/ {
        # API 代理
    }
    
    # 2. 通用路径在最后
    location / {
        # 前端路由（fallback）
    }
}
```

### 避免的配置错误

1. ❌ 重复定义 upstream
2. ❌ Location 顺序错误（通用在前，具体在后）
3. ❌ server_name 不匹配实际域名
4. ❌ 缺少必要的 proxy_set_header
5. ❌ SSL 配置错误但强制重定向到 HTTPS

## 快速恢复命令

### 如果服务完全宕机

```bash
# 1. 停止服务
sudo systemctl stop nginx

# 2. 备份并清理配置
sudo mkdir -p /etc/nginx/conf.d/backup
sudo mv /etc/nginx/conf.d/*.conf /etc/nginx/conf.d/backup/ 2>/dev/null || true

# 3. 创建最简单配置（见上面的最终修复方案）

# 4. 测试并启动
sudo nginx -t && sudo systemctl start nginx

# 5. 验证
curl http://127.0.0.1:8000/api/health
curl http://127.0.0.1/api/health
```

## 总结

这次故障的根本原因是：
1. **配置管理不当** - 配置过于复杂，包含不必要功能
2. **测试不足** - 没有充分测试配置就应用
3. **缺乏备份** - 没有快速回滚机制
4. **权限混乱** - 文件权限不一致导致操作失败

**关键教训**：
- 保持配置简洁
- 始终先测试再应用
- 保留最简单的可用配置作为备份
- 故障时先恢复基本功能，再逐步完善

---

**报告生成时间**: 2026年2月1日
**报告作者**: AI Assistant
**下次审查**: 建议每月审查一次配置和流程

