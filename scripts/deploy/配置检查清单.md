# Nginx 配置检查清单

## 修改配置前

- [ ] 备份当前配置
  ```bash
  sudo cp /etc/nginx/conf.d/my-fullstack-app.conf /etc/nginx/conf.d/my-fullstack-app.conf.backup.$(date +%Y%m%d_%H%M%S)
  ```

- [ ] 检查当前配置是否有错误
  ```bash
  sudo nginx -t
  ```

- [ ] 记录当前服务状态
  ```bash
  sudo systemctl status nginx
  sudo systemctl status my-fullstack-app
  ```

## 配置内容检查

- [ ] Location 顺序正确（具体路径在前，通用路径在后）
  ```nginx
  location /data/ { ... }  # 在前
  location /api/ { ... }    # 在中
  location / { ... }        # 在后
  ```

- [ ] 没有重复的 upstream 定义
  ```bash
  sudo grep "upstream" /etc/nginx/conf.d/my-fullstack-app.conf | sort | uniq -d
  ```

- [ ] server_name 匹配实际域名
  ```nginx
  server_name linchuan.tech www.linchuan.tech 47.112.29.212;
  ```

- [ ] 所有 proxy_pass 都有必要的 proxy_set_header
  ```nginx
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  ```

- [ ] SSL 配置正确（如果使用 HTTPS）
  ```bash
  sudo ls -la /etc/nginx/ssl/linchuan.tech/
  ```

## 应用配置前

- [ ] 测试配置语法
  ```bash
  sudo nginx -t
  ```
  - 必须显示 "test is successful"
  - 如果有错误，不要应用配置

- [ ] 检查是否有配置冲突
  ```bash
  ls -la /etc/nginx/conf.d/
  ls -la /etc/nginx/sites-enabled/
  ```

## 应用配置后

- [ ] 检查服务状态
  ```bash
  sudo systemctl status nginx
  sudo systemctl status my-fullstack-app
  ```

- [ ] 测试后端 API
  ```bash
  curl http://127.0.0.1:8000/api/health
  ```
  - 应该返回 `{"status":"ok"}`

- [ ] 测试 Nginx 代理
  ```bash
  curl http://127.0.0.1/api/health
  # 或
  curl -k https://127.0.0.1/api/health
  ```
  - 应该返回 `{"status":"ok"}`

- [ ] 测试静态文件
  ```bash
  curl -I http://127.0.0.1/data/book-covers/s3259913.jpg
  ```
  - 应该返回 HTTP 200

- [ ] 检查错误日志
  ```bash
  sudo tail -n 20 /var/log/nginx/error.log
  ```

## 权限检查

- [ ] 项目目录权限正确
  ```bash
  ls -la /var/www/my-fullstack-app | head -5
  ```

- [ ] 数据目录权限正确
  ```bash
  ls -la /var/www/my-fullstack-app/data/
  ```

- [ ] 服务用户有读取权限
  ```bash
  SERVICE_USER=$(systemctl show -p User my-fullstack-app | cut -d= -f2)
  sudo -u "$SERVICE_USER" ls /var/www/my-fullstack-app/data/
  ```

## 防火墙检查

- [ ] 防火墙端口开放
  ```bash
  sudo firewall-cmd --list-ports
  sudo firewall-cmd --list-services
  ```

- [ ] 阿里云安全组配置正确
  - 端口 80 (HTTP) 开放
  - 端口 443 (HTTPS) 开放（如果使用）
  - 授权对象: 0.0.0.0/0

## 紧急恢复

如果配置错误导致服务无法启动：

1. 停止 Nginx
   ```bash
   sudo systemctl stop nginx
   ```

2. 恢复备份配置
   ```bash
   sudo cp /etc/nginx/conf.d/my-fullstack-app.conf.backup.* /etc/nginx/conf.d/my-fullstack-app.conf
   ```

3. 或使用最简单配置（见故障报告）

4. 测试并启动
   ```bash
   sudo nginx -t && sudo systemctl start nginx
   ```

---

**使用说明**: 每次修改 Nginx 配置前，请逐项检查此清单

